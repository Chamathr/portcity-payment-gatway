<script>
    window.onload = function (event) {
        Checkout.showPaymentPage()
    };
</script>

<script>
    const params = new Proxy(new URLSearchParams(window.location.search), {
        get: (searchParams, prop) => searchParams.get(prop),
    });

    const merchantId = 'TESTCOMTESIPGLKR';
    const orderId = params.userId;
    const sessionId = params.sessionId;
    const successIndicator = params.successIndicator;

</script>

<script src="https://cbcmpgs.gateway.mastercard.com/checkout/version/61/checkout.js" data-error="errorCallback"
    data-beforeRedirect="beforeRedirect" data-afterRedirect="afterRedirect" data-cancel="cancelCallback"
    data-complete="completeCallback">
    </script>
<script inline="javascript">

    var resultIndicator = null;
    // This method preserves the current state of successIndicator and orderId, so they're not overwritten when we return to this page after redirect
    function beforeRedirect() {
        return {
            successIndicator: successIndicator,
            orderId: orderId
        };
    }
    // This method is specifically for the full payment page option. Because we leave this page and return to it, we need to preserve the
    // state of successIndicator and orderId using the beforeRedirect/afterRedirect option
    function afterRedirect(data) {
        // Compare with the resultIndicator saved in the completeCallback() method
        if (resultIndicator) {
            var result = (resultIndicator === data.successIndicator) ? "SUCCESS" : "ERROR";
            // window.location.href = "/process/pay/" + data.orderId + "/" + result;
            window.location.href = `https://9ec2-2407-c00-d001-6aef-48c2-e30f-f35a-a8d5.in.ngrok.io/process/pay/${data.orderId}/${result}`;
        }
        else {
            successIndicator = data.successIndicator;
            orderId = data.orderId;
            sessionId = data.sessionId;
            sessionVersion = data.sessionVersion;
            merchantId = data.merchantId;

            // window.location.href = "/process/pay/" + data.orderId + "/" + data.successIndicator + "/" + data.sessionId;
            window.location.href = `https://9ec2-2407-c00-d001-6aef-48c2-e30f-f35a-a8d5.in.ngrok.io/process/pay/${data.orderId}/${data.successIndicator}/${data.sessionId}`;

        }
    }

    function errorCallback(error) {
        var message = JSON.stringify(error);
        $("#loading-bar-spinner").hide();
        var $errorAlert = $('#error-alert');
        console.log(message);
        $errorAlert.append("<p>" + message + "</p>");
        $errorAlert.show();
    }

    cancelCallback = "https://google.com"
    // function cancelCallback() {
    //     console.log('Payment cancelled');
    //     // Reload the page to generate a new session ID - the old one is out of date as soon as the lightbox is invoked
    //     window.location.reload(true);
    // }

    // This handles the response from Hosted Checkout and redirects to the appropriate endpoint
    function completeCallback(response) {
        // Save the resultIndicator
        resultIndicator = response;
        var result = (resultIndicator === successIndicator) ? "SUCCESS" : "ERROR";
        // window.location.href = "/process/pay/" + orderId + "/" + result;
        window.location.href = `https://9ec2-2407-c00-d001-6aef-48c2-e30f-f35a-a8d5.in.ngrok.io/process/pay/${orderId}/${result}`;

    }

    /*function randomId() {
        var chars = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ", length = 10;
        var result = '';
        for (var i = length; i > 0; --i) result += chars[Math.round(Math.random() * (chars.length - 1))];
        return result;
    }*/
    Checkout.configure({
        merchant: merchantId,
        session: {
            id: sessionId
        }
    });
</script>

</body>
</div>
</div>
</body>